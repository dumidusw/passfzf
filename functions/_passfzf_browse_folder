#!/usr/bin/env zsh
# Helper function: browse a specific folder (with subfolder support)

_passfzf_browse_folder() {
    local pass_dir="$1"
    local folder="$2"
    
    echo "ğŸ“‚ Expanding folder: $folder"
    
    local -a folder_entries=("âœ¨ + Add New Password" "ğŸ“ â† Back to categories")
    
    # Add subfolders first
    while IFS= read -r -d '' subdir; do
        [[ -z "$subdir" ]] && continue
        folder_entries+=("ğŸ“ $folder/$subdir/")
    done < <(find "$pass_dir/$folder" -mindepth 1 -maxdepth 1 -type d -printf '%P\0' 2>/dev/null | sort -z)
    
    # Then add password entries in this folder
    while IFS= read -r -d '' entry; do
        local clean_entry="${entry%.gpg}"
        folder_entries+=("ğŸ” $folder/$clean_entry")
    done < <(find "$pass_dir/$folder" -maxdepth 1 -name "*.gpg" -type f -printf '%P\0' 2>/dev/null | sort -z)

    local folder_entry_count=${#folder_entries[@]}
    local folder_height=$((folder_entry_count + 5))
    local terminal_height=$(tput lines)
    local max_usable_height=$((terminal_height - 5))
    [[ $folder_height -lt 15 ]] && folder_height=15
    [[ $folder_height -gt $max_usable_height ]] && folder_height=$max_usable_height

    local folder_delete_script=$(mktemp -t passfzf-folder-delete-XXXXXX.sh)
    cat > "$folder_delete_script" <<'DELEOF'
#!/bin/bash
entry="$1"
exec < /dev/tty
echo "âš ï¸  DELETE CONFIRMATION"
echo ""
echo "You are about to DELETE:"
echo "  $entry"
echo ""
echo "Type YES to confirm deletion, or anything else to cancel:"
read -r confirm
if [[ "$confirm" == "YES" ]]; then
    echo "Deleting..."
    if pass rm -f "$entry" &>/dev/null; then
        echo "âœ… Password deleted successfully"
        command -v notify-send >/dev/null 2>&1 && notify-send "ğŸ—‘ï¸ Password Deleted" "$entry" -t 2000 -u low &>/dev/null &
    else
        echo "âŒ Failed to delete: $entry"
    fi
else
    echo "â„¹ï¸ Deletion cancelled."
fi
read -k1 -s "key?Press any key to continue..."
DELEOF
    chmod +x "$folder_delete_script"

    # Folder reload command emits entries (no pinned actions when query active)
    local folder_reload_cmd='
if [[ -n "$FZF_QUERY" ]]; then
    # Show all entries recursively when searching
    find "'"$pass_dir/$folder"'" -name "*.gpg" -printf "%P\n" 2>/dev/null \
      | sed "s/\.gpg$//" \
      | sort \
      | sed "s|^|ğŸ” '"$folder"'/|"
else
    echo "âœ¨ + Add New Password"
    echo "ğŸ“ â† Back to categories"
    # Show subfolders first
    find "'"$pass_dir/$folder"'" -mindepth 1 -maxdepth 1 -type d -printf "%P/\n" 2>/dev/null \
      | sort \
      | sed "s|^|ğŸ“ '"$folder"'/|"
    # Then show entries in current folder
    find "'"$pass_dir/$folder"'" -maxdepth 1 -name "*.gpg" -printf "%P\n" 2>/dev/null \
      | sed "s/\.gpg$//" \
      | sort \
      | sed "s|^|ğŸ” '"$folder"'/|"
fi'

    # Folder-specific header command (used to update header after deletes/edits)
    local dynamic_folder_header_cmd='
folder_count=$(find "'"$pass_dir/$folder"'" -maxdepth 1 -name "*.gpg" -type f 2>/dev/null | wc -l)
subfolder_count=$(find "'"$pass_dir/$folder"'" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
if [[ $subfolder_count -gt 0 ]]; then
    echo "ğŸ“Š Folder: '"$folder"' â€” '"$folder_count"' entries, '"$subfolder_count"' subfolders
ENTER: copy/open â€¢ Ctrl+Y: copy+stay â€¢ Ctrl+E: edit â€¢ Ctrl+D: delete â€¢ â† Back"
else
    echo "ğŸ“Š Folder: '"$folder"' â€” '"$folder_count"' entries
ENTER: copy/open â€¢ Ctrl+Y: copy+stay â€¢ Ctrl+E: edit â€¢ Ctrl+D: delete â€¢ â† Back"
fi'

    local folder_entry_count_actual=$((${#folder_entries[@]} - 2))
    local subfolder_count=$(find "$pass_dir/$folder" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
    local password_count=$(find "$pass_dir/$folder" -maxdepth 1 -name "*.gpg" -type f 2>/dev/null | wc -l)
    
    local prompt_text="ğŸ”‘ $folder/"
    if [[ $subfolder_count -gt 0 ]]; then
        prompt_text+=" ($password_count entries, $subfolder_count folders)> "
    else
        prompt_text+=" ($password_count)> "
    fi
    
    local folder_selection
    folder_selection=$(
        printf '%s\n' "${folder_entries[@]}" | \
        fzf --height ${folder_height} \
            --reverse \
            --prompt="$prompt_text" \
            --header='ENTER: copy/open â€¢ Ctrl+Y: copy+stay â€¢ Ctrl+E: edit â€¢ Ctrl+D: delete â€¢ â† Back' \
            --preview='
                case {} in
                    *"Add New Password"*)
                        echo "âœ¨ Create a new password entry in '"$folder"'/"
                        ;;
                    *"â† Back"*)
                        echo "ğŸ”™ Return to category view"
                        ;;
                    ğŸ“*)
                        subfolder=$(echo {} | cut -d" " -f2- | sed "s|/$||")
                        echo "ğŸ“‚ Subfolder: $subfolder"
                        echo ""
                        echo "Contents:"
                        # Show entries in this subfolder
                        find "'"$pass_dir"'/$subfolder" -maxdepth 1 -name "*.gpg" -printf "%P\n" 2>/dev/null | \
                            sed "s/\.gpg$//" | sort | head -15 | sed "s/^/  ğŸ” /"
                        # Show sub-subfolders if any
                        find "'"$pass_dir"'/$subfolder" -mindepth 1 -maxdepth 1 -type d -printf "%P/\n" 2>/dev/null | \
                            sort | head -10 | sed "s/^/  ğŸ“ /"
                        ;;
                    *)
                        entry=$(echo {} | cut -d" " -f2-)
                        pass show "$entry" 2>/dev/null | sed "1s/.*/ğŸ” [PASSWORD HIDDEN â€” Press ENTER to copy]/" | head -10
                        ;;
                esac' \
            --preview-window='right:50%' \
            --bind "change:reload($folder_reload_cmd)" \
            --bind 'ctrl-y:execute-silent(
                entry=$(echo {} | cut -d" " -f2-)
                pass show -c "$entry" &>/dev/null && command -v notify-send >/dev/null 2>&1 && notify-send "ğŸ” Password Copied" "$entry" -t 1500 -u low &>/dev/null
            )+refresh-preview+clear-screen' \
            --bind 'ctrl-e:execute(
                if [[ {} == ğŸ“* || {} == *"Add New Password"* || {} == *"â† Back"* ]]; then
                    echo "âš ï¸  Edit operation not available for this item"
                    read -k1 -s "key?Press any key to continue..."
                else
                    entry=$(echo {} | cut -d" " -f2-)
                    EDITOR=${EDITOR:-nvim} pass edit "$entry"
                fi
            )+reload('"$folder_reload_cmd"')+transform-header('"$dynamic_folder_header_cmd"')' \
            --bind 'ctrl-d:execute(
                if [[ {} == ğŸ“* || {} == *"Add New Password"* || {} == *"â† Back"* ]]; then
                    echo "âš ï¸  Delete operation not available for this item"
                    read -k1 -s "key?Press any key to continue..."
                else
                    entry=$(echo {} | cut -d" " -f2-)
                    '"$folder_delete_script"' "$entry"
                fi
            )+reload('"$folder_reload_cmd"')+transform-header('"$dynamic_folder_header_cmd"')' \
            --bind 'ctrl-n:execute-silent(echo "ğŸ“ â† Back to categories")+accept'
			--bind 'ctrl-o:execute(
				if [[ {} == ğŸ“* || {} == *"Add New Password"* || {} == *"â† Back"* ]]; then
					echo "âš ï¸  URL open not available for this item"
					read -k1 -s "key?Press any key to continue..."
				else
					entry=$(echo {} | cut -d" " -f2-)
					_passfzf_open_url "$entry"
				fi
				)'
    )

    rm -f "$folder_delete_script"

    case "$folder_selection" in
        *"â† Back"*)
            passfzf
            ;;
        *"Add New Password"*)
            _passfzf_add_folder_password "$pass_dir" "$folder"
            ;;
        ğŸ“*)
            # Handle subfolder selection - recursively browse the subfolder
            local subfolder_path=$(echo "$folder_selection" | cut -d" " -f2- | sed 's|/$||')
            _passfzf_browse_folder "$pass_dir" "$subfolder_path"
            ;;
        *)
            if [[ -n "$folder_selection" ]]; then
                local real_path="${folder_selection#* }"
                if pass show -c "$real_path" &>/dev/null; then
                    local display_name="${real_path##*/}"
                    local parent_folder="${real_path%/*}"
                    echo "ğŸ” Password copied: $display_name (from $parent_folder)"
                    command -v notify-send >/dev/null 2>&1 && {
                        notify-send "ğŸ” Password Copied" "$display_name" -t 2000 -u low &>/dev/null &
                        disown
                    }
                    echo "â³ Will clear from clipboard in 45 seconds"
                else
                    echo "âŒ Failed to copy: $real_path"
                fi
            fi
            ;;
    esac
}
